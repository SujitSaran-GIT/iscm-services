databaseChangeLog:

  - changeSet:
      id: 009-add-mfa-columns-to-users
      author: iscm-team
      changes:
        - addColumn:
            tableName: users
            columns:
              - column: {name: mfa_enabled, type: BOOLEAN, constraints: {nullable: false, defaultValue: false}}
              - column: {name: mfa_secret, type: VARCHAR(255), constraints: {nullable: true}}
              - column: {name: mfa_type, type: VARCHAR(50), constraints: {nullable: true}}
              - column: {name: mfa_phone, type: VARCHAR(20), constraints: {nullable: true}}
              - column: {name: mfa_backup_codes, type: TEXT, constraints: {nullable: true}}

  - changeSet:
      id: 010-create-password-reset-tokens-table
      author: iscm-team
      changes:
        - createTable:
            tableName: password_reset_tokens
            columns:
              - column: {name: id, type: UUID, constraints: {primaryKey: true, nullable: false}}
              - column: {name: token, type: VARCHAR(255), constraints: {nullable: false, unique: true}}
              - column: {name: user_id, type: UUID, constraints: {nullable: false}}
              - column: {name: expires_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: used_at, type: TIMESTAMP, constraints: {nullable: true}}
              - column: {name: is_used, type: BOOLEAN, constraints: {nullable: false, defaultValue: false}}
              - column: {name: tenant_id, type: UUID, constraints: {nullable: true}}
              - column: {name: created_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: updated_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: version, type: INT, constraints: {nullable: false, defaultValue: 0}}
        - addForeignKeyConstraint:
            baseTableName: password_reset_tokens
            baseColumnNames: user_id
            constraintName: fk_password_reset_tokens_user
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            indexName: idx_password_reset_tokens_token
            tableName: password_reset_tokens
            columns:
              - column: {name: token}

  - changeSet:
      id: 011-create-login-attempts-table
      author: iscm-team
      changes:
        - createTable:
            tableName: login_attempts
            columns:
              - column: {name: id, type: UUID, constraints: {primaryKey: true, nullable: false}}
              - column: {name: user_id, type: UUID, constraints: {nullable: false}}
              - column: {name: ip_address, type: VARCHAR(45), constraints: {nullable: false}}
              - column: {name: user_agent, type: TEXT, constraints: {nullable: true}}
              - column: {name: successful, type: BOOLEAN, constraints: {nullable: false}}
              - column: {name: attempt_time, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: failure_reason, type: VARCHAR(255), constraints: {nullable: true}}
              - column: {name: tenant_id, type: UUID, constraints: {nullable: true}}
              - column: {name: created_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: updated_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: version, type: INT, constraints: {nullable: false, defaultValue: 0}}
        - createIndex:
            indexName: idx_login_attempts_user
            tableName: login_attempts
            columns:
              - column: {name: user_id}
        - createIndex:
            indexName: idx_login_attempts_time
            tableName: login_attempts
            columns:
              - column: {name: attempt_time}
        - createIndex:
            indexName: idx_login_attempts_ip
            tableName: login_attempts
            columns:
              - column: {name: ip_address}

  - changeSet:
      id: 012-create-suspicious-activities-table
      author: iscm-team
      changes:
        - createTable:
            tableName: suspicious_activities
            columns:
              - column: {name: id, type: UUID, constraints: {primaryKey: true, nullable: false}}
              - column: {name: user_id, type: UUID, constraints: {nullable: false}}
              - column: {name: ip_address, type: VARCHAR(45), constraints: {nullable: false}}
              - column: {name: activity_type, type: VARCHAR(100), constraints: {nullable: false}}
              - column: {name: timestamp, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: severity, type: VARCHAR(20), constraints: {nullable: true}}
              - column: {name: description, type: TEXT, constraints: {nullable: true}}
              - column: {name: investigated, type: BOOLEAN, constraints: {nullable: false, defaultValue: false}}
              - column: {name: tenant_id, type: UUID, constraints: {nullable: true}}
              - column: {name: created_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: updated_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: version, type: INT, constraints: {nullable: false, defaultValue: 0}}
        - createIndex:
            indexName: idx_suspicious_activities_user
            tableName: suspicious_activities
            columns:
              - column: {name: user_id}
        - createIndex:
            indexName: idx_suspicious_activities_time
            tableName: suspicious_activities
            columns:
              - column: {name: timestamp}
        - createIndex:
            indexName: idx_suspicious_activities_type
            tableName: suspicious_activities
            columns:
              - column: {name: activity_type}

  - changeSet:
      id: 013-create-user-devices-table
      author: iscm-team
      changes:
        - createTable:
            tableName: user_devices
            columns:
              - column: {name: id, type: UUID, constraints: {primaryKey: true, nullable: false}}
              - column: {name: user_id, type: UUID, constraints: {nullable: false}}
              - column: {name: device_fingerprint, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: device_name, type: VARCHAR(255), constraints: {nullable: true}}
              - column: {name: device_type, type: VARCHAR(50), constraints: {nullable: true}}
              - column: {name: operating_system, type: VARCHAR(100), constraints: {nullable: true}}
              - column: {name: browser, type: VARCHAR(100), constraints: {nullable: true}}
              - column: {name: last_seen_ip, type: VARCHAR(45), constraints: {nullable: true}}
              - column: {name: last_seen_at, type: TIMESTAMP, constraints: {nullable: true}}
              - column: {name: first_seen_at, type: TIMESTAMP, constraints: {nullable: true}}
              - column: {name: is_trusted, type: BOOLEAN, constraints: {nullable: false, defaultValue: false}}
              - column: {name: is_blocked, type: BOOLEAN, constraints: {nullable: false, defaultValue: false}}
              - column: {name: trust_score, type: INT, constraints: {nullable: false, defaultValue: 50}}
              - column: {name: tenant_id, type: UUID, constraints: {nullable: true}}
              - column: {name: created_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: updated_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: version, type: INT, constraints: {nullable: false, defaultValue: 0}}
        - addForeignKeyConstraint:
            baseTableName: user_devices
            baseColumnNames: user_id
            constraintName: fk_user_devices_user
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            indexName: idx_user_devices_fingerprint
            tableName: user_devices
            columns:
              - column: {name: device_fingerprint}

  - changeSet:
      id: 014-create-oauth-accounts-table
      author: iscm-team
      changes:
        - createTable:
            tableName: oauth_accounts
            columns:
              - column: {name: id, type: UUID, constraints: {primaryKey: true, nullable: false}}
              - column: {name: user_id, type: UUID, constraints: {nullable: false}}
              - column: {name: provider, type: VARCHAR(50), constraints: {nullable: false}}
              - column: {name: provider_id, type: VARCHAR(255), constraints: {nullable: false}}
              - column: {name: provider_username, type: VARCHAR(255), constraints: {nullable: true}}
              - column: {name: email, type: VARCHAR(255), constraints: {nullable: true}}
              - column: {name: access_token, type: TEXT, constraints: {nullable: true}}
              - column: {name: refresh_token, type: TEXT, constraints: {nullable: true}}
              - column: {name: token_expiry, type: TIMESTAMP, constraints: {nullable: true}}
              - column: {name: scopes, type: TEXT, constraints: {nullable: true}}
              - column: {name: is_active, type: BOOLEAN, constraints: {nullable: false, defaultValue: true}}
              - column: {name: tenant_id, type: UUID, constraints: {nullable: true}}
              - column: {name: created_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: updated_at, type: TIMESTAMP, constraints: {nullable: false}}
              - column: {name: version, type: INT, constraints: {nullable: false, defaultValue: 0}}
        - addForeignKeyConstraint:
            baseTableName: oauth_accounts
            baseColumnNames: user_id
            constraintName: fk_oauth_accounts_user
            referencedTableName: users
            referencedColumnNames: id
        - createIndex:
            indexName: idx_oauth_accounts_provider
            tableName: oauth_accounts
            columns:
              - column: {name: provider}
        - createIndex:
            indexName: idx_oauth_accounts_provider_id
            tableName: oauth_accounts
            columns:
              - column: {name: provider_id}

  - changeSet:
      id: 015-additional-user-roles
      author: iscm-team
      changes:
        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000202"}
              - column: {name: name, value: "ADMIN"}
              - column: {name: description, value: "Administrator with organizational access"}
              - column: {name: scope, value: "ORGANIZATION"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000203"}
              - column: {name: name, value: "USER"}
              - column: {name: description, value: "Regular user with basic access"}
              - column: {name: scope, value: "PLATFORM"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000204"}
              - column: {name: name, value: "OPS"}
              - column: {name: description, value: "Operations team member"}
              - column: {name: scope, value: "PLATFORM"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000205"}
              - column: {name: name, value: "BUYER"}
              - column: {name: description, value: "Buyer role for procurement"}
              - column: {name: scope, value: "ORGANIZATION"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000206"}
              - column: {name: name, value: "VENDOR"}
              - column: {name: description, value: "Vendor role for suppliers"}
              - column: {name: scope, value: "ORGANIZATION"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000207"}
              - column: {name: name, value: "COURIER"}
              - column: {name: description, value: "Courier role for delivery services"}
              - column: {name: scope, value: "ORGANIZATION"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}

        - insert:
            tableName: roles
            columns:
              - column: {name: id, value: "00000000-0000-0000-0000-000000000208"}
              - column: {name: name, value: "ANALYST"}
              - column: {name: description, value: "Analyst role for data analysis"}
              - column: {name: scope, value: "ORGANIZATION"}
              - column: {name: created_at, value: "now()"}
              - column: {name: updated_at, value: "now()"}