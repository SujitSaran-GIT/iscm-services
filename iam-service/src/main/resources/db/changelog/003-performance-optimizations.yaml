databaseChangeLog:
  - changeSet:
      id: create-performance-indexes
      author: iscm-team
      context: performance
      changes:
        # User table indexes for authentication queries
        - createIndex:
            tableName: users
            indexName: idx_users_email_active
            columns:
              - column:
                  name: email
              - column:
                  name: is_active
            unique: true

        - createIndex:
            tableName: users
            indexName: idx_users_tenant_id
            columns:
              - column:
                  name: tenant_id

        - createIndex:
            tableName: users
            indexName: idx_users_last_login
            columns:
              - column:
                  name: last_login_at

        - createIndex:
            tableName: users
            indexName: idx_users_created_at
            columns:
              - column:
                  name: created_at

        # User roles table indexes for authorization queries
        - createIndex:
            tableName: user_roles
            indexName: idx_user_roles_user_id_role_id
            columns:
              - column:
                  name: user_id
              - column:
                  name: role_id
            unique: true

        - createIndex:
            tableName: user_roles
            indexName: idx_user_roles_tenant_id
            columns:
              - column:
                  name: tenant_id

        # User sessions table indexes for session management
        - createIndex:
            tableName: user_sessions
            indexName: idx_user_sessions_user_id_active
            columns:
              - column:
                  name: user_id
              - column:
                  name: revoked
              - column:
                  name: expires_at

        - createIndex:
            tableName: user_sessions
            indexName: idx_user_sessions_refresh_token_hash
            columns:
              - column:
                  name: refresh_token_hash

        - createIndex:
            tableName: user_sessions
            indexName: idx_user_sessions_ip_address
            columns:
              - column:
                  name: ip_address

        # Login attempts table indexes for security monitoring
        - createIndex:
            tableName: login_attempts
            indexName: idx_login_attempts_user_time
            columns:
              - column:
                  name: user_id
              - column:
                  name: attempt_time

        - createIndex:
            tableName: login_attempts
            indexName: idx_login_attempts_ip_time
            columns:
              - column:
                  name: ip_address
              - column:
                  name: attempt_time

        - createIndex:
            tableName: login_attempts
            indexName: idx_login_attempts_successful_time
            columns:
              - column:
                  name: successful
              - column:
                  name: attempt_time

        # Suspicious activities table indexes for security monitoring
        - createIndex:
            tableName: suspicious_activities
            indexName: idx_suspicious_activities_user_severity
            columns:
              - column:
                  name: user_id
              - column:
                  name: severity
              - column:
                  name: investigated
              - column:
                  name: timestamp

        - createIndex:
            tableName: suspicious_activities
            indexName: idx_suspicious_activities_type_timestamp
            columns:
              - column:
                  name: activity_type
              - column:
                  name: timestamp

        - createIndex:
            tableName: suspicious_activities
            indexName: idx_suspicious_activities_ip_timestamp
            columns:
              - column:
                  name: ip_address
              - column:
                  name: timestamp

        # Password reset tokens table indexes (additional ones - basic indexes already exist in 002-security-features.yaml)
        - createIndex:
            tableName: password_reset_tokens
            indexName: idx_password_reset_tokens_user_expires
            columns:
              - column:
                  name: user_id
              - column:
                  name: expires_at
              - column:
                  name: is_used

        # User devices table indexes
        - createIndex:
            tableName: user_devices
            indexName: idx_user_devices_user_id_trusted
            columns:
              - column:
                  name: user_id
              - column:
                  name: is_trusted
              - column:
                  name: last_seen_at

        # Note: idx_user_devices_device_fingerprint already exists in 002-security-features.yaml

        # OAuth accounts table indexes
        - createIndex:
            tableName: oauth_accounts
            indexName: idx_oauth_accounts_user_provider
            columns:
              - column:
                  name: user_id
              - column:
                  name: provider
              - column:
                  name: provider_id
            unique: true

  - changeSet:
      id: optimize-table-partitioning
      author: iscm-team
      context: performance
      changes:
        # Add table comments for optimization hints
        - sql:
            sql: |
              COMMENT ON TABLE users IS 'Core user table - high read/write access during authentication';
              COMMENT ON TABLE user_sessions IS 'Session management table - frequent updates and queries';
              COMMENT ON TABLE login_attempts IS 'Security monitoring table - high insert rate';
              COMMENT ON TABLE suspicious_activities IS 'Security events table - high insert rate';
              COMMENT ON TABLE user_roles IS 'Authorization table - frequent join queries';

  - changeSet:
      id: create-query-optimized-views
      author: iscm-team
      context: performance
      changes:
        # Create optimized view for user security profile
        - createView:
            viewName: v_user_security_profile
            selectQuery: |
              SELECT
                u.id,
                u.email,
                u.is_active,
                u.failed_login_attempts,
                u.account_locked_until,
                u.last_login_at,
                u.mfa_enabled,
                COUNT(CASE WHEN la.successful = false AND la.attempt_time > NOW() - INTERVAL '24 hours' THEN 1 END) as failed_attempts_24h,
                COUNT(CASE WHEN la.successful = true AND la.attempt_time > NOW() - INTERVAL '24 hours' THEN 1 END) as successful_logins_24h,
                COUNT(CASE WHEN sa.severity = 'HIGH' AND sa.investigated = false THEN 1 END) as high_priority_alerts,
                COUNT(DISTINCT ud.id) FILTER (WHERE ud.is_trusted = true) as trusted_devices
              FROM users u
              LEFT JOIN login_attempts la ON u.id = la.user_id
              LEFT JOIN suspicious_activities sa ON u.id = sa.user_id
              LEFT JOIN user_devices ud ON u.id = ud.user_id
              GROUP BY u.id, u.email, u.is_active, u.failed_login_attempts,
                       u.account_locked_until, u.last_login_at, u.mfa_enabled

        # Create optimized view for active sessions
        - createView:
            viewName: v_active_user_sessions
            selectQuery: |
              SELECT
                us.id,
                us.user_id,
                u.email,
                us.ip_address,
                us.user_agent,
                us.created_at,
                us.expires_at,
                CASE
                  WHEN us.expires_at <= NOW() THEN 'expired'
                  WHEN us.revoked = true THEN 'revoked'
                  ELSE 'active'
                END as status
              FROM user_sessions us
              JOIN users u ON us.user_id = u.id
              WHERE us.revoked = false AND us.expires_at > NOW()

  # Note: Materialized views and procedures removed due to SQL syntax issues with Liquibase
# Can be added later manually or with a different migration approach